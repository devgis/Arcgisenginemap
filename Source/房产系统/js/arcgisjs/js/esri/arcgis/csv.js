/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/arcgis/csv","dojo/_base/lang dojo/_base/array dojo/_base/Deferred dojo/sniff dojo/number dojox/data/CsvStore esri/kernel esri/config esri/request esri/SpatialReference esri/geometry/Geometry esri/geometry/jsonUtils esri/geometry/webMercatorUtils".split(" "),function(h,d,z,q,K,L,M,A,N,t,n,B,C){function D(a){var b=0,c="";d.forEach([","," ",";","|","\t"],function(e){var d=a.split(e).length;d>b&&(b=d,c=e)});return c}function E(a,b){if(!a||"[object Date]"!==Object.prototype.toString.call(a)||
isNaN(a.getTime()))return!1;var c=!0;if(q("chrome")&&/\d+\W*$/.test(b)){var e=b.match(/[a-zA-Z]{2,}/);if(e){for(var c=!1,d=0,l=e.length,u=/^((jan(uary)?)|(feb(ruary)?)|(mar(ch)?)|(apr(il)?)|(may)|(jun(e)?)|(jul(y)?)|(aug(ust)?)|(sep(tember)?)|(oct(ober)?)|(nov(ember)?)|(dec(ember)?)|(am)|(pm)|(gmt)|(utc))$/i;!c&&d<=l&&!(c=!u.test(e[d]));)d++;c=!c}}return c}function F(a,b,c){var e=a.indexOf("\n"),e=h.trim(a.substr(0,e)),f=b.columnDelimiter;f||(f=D(e));var l=new L({data:a,separator:f});a=9>q("ie")?
750:1001;l.fetch({start:0,count:a,onComplete:function(a,e){var g=0,f={layerDefinition:b.layerDefinition,featureSet:{features:[],geometryType:"esriGeometryPoint"}},x=f.layerDefinition.objectIdField;!x&&!d.some(f.layerDefinition.fields,function(a){return"esriFieldTypeOID"==a.type?(x=a.name,!0):!1})&&(f.layerDefinition.fields.push({name:"__OBJECTID",alias:"__OBJECTID",type:"esriFieldTypeOID",editable:!1,domain:null}),x="__OBJECTID");var h,p,r=l._attributes,q=[],s=[];d.forEach(f.layerDefinition.fields,
function(a,g){"esriFieldTypeDate"===a.type?q.push(a.name):("esriFieldTypeDouble"===a.type||"esriFieldTypeInteger"===a.type)&&s.push(a.name)});b.locationInfo&&"coordinates"===b.locationInfo.locationType?(h=b.locationInfo.latitudeFieldName,p=b.locationInfo.longitudeFieldName):d.forEach(r,function(a){var g;g=d.indexOf(G,a.toLowerCase());-1!==g&&(h=a);g=d.indexOf(H,a.toLowerCase());-1!==g&&(p=a)},this);if(!h||!p)setTimeout(function(){console.error("File does not seem to contain fields with point coordinates.")},
1),c&&c(null,Error("File does not seem to contain fields with point coordinates."));else{-1===d.indexOf(s,h)&&s.push(h);-1===d.indexOf(s,p)&&s.push(p);var r=0,t=a.length;for(r;r<t;r++){if(1E3<=f.featureSet.features.length){setTimeout(function(){console.error("1000 feature limit reached. Unable to load any more data.")},1);break}var v=a[r],w=l.getAttributes(v),m={};d.forEach(w,function(a,g){if(a){var b=a;0===a.length&&d.forEach(f.layerDefinition.fields,function(g,b){g.name==="attribute_"+(b-1)&&(a=
"attribute_"+(b-1))});if(-1<d.indexOf(q,a)){var b=l.getValue(v,b),c=new Date(b);m[a]=E(c,b)?c.getTime():null}else if(-1<d.indexOf(s,a)){c=K.parse(l.getValue(v,b));if((a==h||a==p)&&(isNaN(c)||181<Math.abs(c)))c=parseFloat(l.getValue(v,b));isNaN(c)?m[a]=null:m[a]=c}else m[a]=l.getValue(v,b)}});m[x]=g;g++;var w=m[h],n=m[p];null==n||(null==w||isNaN(w)||isNaN(n))||f.featureSet.features.push({geometry:{x:n,y:w,spatialReference:{wkid:4326}},attributes:m})}f.layerDefinition.name="csv";c&&c(f)}},onError:function(a){console.error("Error fetching items from CSV store: ",
a);c&&c(null,a)}});return!0}function y(a,b,c,e,f,l){0===a.length&&f(null);var u=B.getGeometryType(b),k=[];d.forEach(a,function(a){a=new u(a);a.spatialReference=c;k.push(a)},this);b=[102113,102100,3857];c.wkid&&4326===c.wkid&&e.wkid&&-1<d.indexOf(b,e.wkid)?(d.forEach(k,function(a){a.xmin?(a.xmin=Math.max(a.xmin,-180),a.xmax=Math.min(a.xmax,180),a.ymin=Math.max(a.ymin,-89.99),a.ymax=Math.min(a.ymax,89.99)):a.rings?d.forEach(a.rings,function(a){d.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),
180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.paths?d.forEach(a.paths,function(a){d.forEach(a,function(a){a[0]=Math.min(Math.max(a[0],-180),180);a[1]=Math.min(Math.max(a[1],-89.99),89.99)},this)},this):a.x&&(a.x=Math.min(Math.max(a.x,-180),180),a.y=Math.min(Math.max(a.y,-89.99),89.99))},this),a=[],d.forEach(k,function(b){b=C.geographicToWebMercator(b);102100!==e.wkid&&(b.spatialReference=e);a.push(b.toJson())},this),f(a)):null!==c.wkid&&-1<d.indexOf(b,c.wkid)&&null!==e.wkid&&4326===
e.wkid?(a=[],d.forEach(k,function(b){a.push(C.webMercatorToGeographic(b).toJson())},this),f(a)):(b=function(b,c){b&&b.length===a.length?(a=[],d.forEach(b,function(b){b&&(b.rings&&0<b.rings.length&&0<b.rings[0].length&&0<b.rings[0][0].length&&!isNaN(b.rings[0][0][0])&&!isNaN(b.rings[0][0][1])||b.paths&&0<b.paths.length&&0<b.paths[0].length&&0<b.paths[0][0].length&&!isNaN(b.paths[0][0][0])&&!isNaN(b.paths[0][0][1])||b.xmin&&!isNaN(b.xmin)&&b.ymin&&!isNaN(b.ymin)||b.x&&!isNaN(b.x)&&b.y&&!isNaN(b.y))?
a.push(b.toJson()):a.push(null)},this),f(a)):l(b,c)},A.defaults.geometryService?A.defaults.geometryService.project(k,e,h.hitch(this,b),l):f(null))}function I(a,b){var c=[102113,102100,3857];return a&&b&&a.wkid===b.wkid&&a.wkt===b.wkt||a&&b&&a.wkid&&b.wkid&&-1<d.indexOf(c,a.wkid)&&-1<d.indexOf(c,b.wkid)?!0:!1}function J(a,b,c,e){if(a.featureSet&&0!==a.featureSet.features.length)if(I(c,b))e(a);else{var f=function(b){var c=[];d.forEach(a.featureSet.features,function(a,e){b[e]&&(a.geometry=b[e],c.push(a))},
this);e(a)},l=function(b,c){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Final try.");e(a)},u=function(e,d){console.error("error projecting featureSet ("+a.layerDefinition.name+"). Try one more time.");y(k,a.featureSet.geometryType,b,c,h.hitch(this,f),h.hitch(this,l))};if(a.featureSet.features&&0<a.featureSet.features.length){var k=[];d.forEach(a.featureSet.features,function(b){if(b.geometry.toJson)k.push(b.geometry);else{var c=B.getGeometryType(a.featureSet.geometryType);
k.push(new c(b.geometry))}});b.toJson||(b=new t(b));c.toJson||(c=new t(c));y(k,a.featureSet.geometryType,b,c,h.hitch(this,f),h.hitch(this,u))}else e(a)}}var G="lat latitude y ycenter latitude83 latdecdeg POINT-Y".split(" "),H="lon lng long longitude x xcenter longitude83 longdecdeg POINT-X".split(" ");n={latFieldStrings:G,longFieldStrings:H,buildCSVFeatureCollection:function(a){var b=new z,c=function(a,c){c?b.errback(c):b.callback(a)};N({url:a.url,handleAs:"text",load:function(b){F(b,a,h.hitch(this,
c))},error:function(a){b.errback(a);console.error("error: "+a)}},{usePost:!1});return b},projectFeatureCollection:function(a,b,c){var d=new z;c||(c=new t({wkid:4326}));J(a,c,b,h.hitch(this,function(a){d.callback(a)}));return d},generateDefaultPopupInfo:function(a){var b={esriFieldTypeDouble:1,esriFieldTypeSingle:1},c={esriFieldTypeInteger:1,esriFieldTypeSmallInteger:1},e={esriFieldTypeDate:1},f=null;a=d.map(a.layerDefinition.fields,h.hitch(this,function(a){"NAME"===a.name.toUpperCase()&&(f=a.name);
var d="esriFieldTypeOID"!==a.type&&"esriFieldTypeGlobalID"!==a.type&&"esriFieldTypeGeometry"!==a.type,k=null;if(d){var g=a.name.toLowerCase();if(-1<",stretched value,fnode_,tnode_,lpoly_,rpoly_,poly_,subclass,subclass_,rings_ok,rings_nok,".indexOf(","+g+",")||-1<g.indexOf("area")||-1<g.indexOf("length")||-1<g.indexOf("shape")||-1<g.indexOf("perimeter")||-1<g.indexOf("objectid")||g.indexOf("_")===g.length-1||g.indexOf("_i")===g.length-2&&1<g.length)d=!1;a.type in c?k={places:0,digitSeparator:!0}:a.type in
b?k={places:2,digitSeparator:!0}:a.type in e&&(k={dateFormat:"shortDateShortTime"})}return h.mixin({},{fieldName:a.name,label:a.alias,isEditable:!0,tooltip:"",visible:d,format:k,stringFieldOption:"textbox"})}));return{title:f?"{"+f+"}":"",fieldInfos:a,description:null,showAttachments:!1,mediaInfos:[]}},_getSeparator:D,_isValidDate:E,_processCsvData:F,_projectGeometries:y,_sameSpatialReference:I,_projectFeatureSet:J};q("extend-esri")&&h.setObject("arcgis.csv",n,M);return n});