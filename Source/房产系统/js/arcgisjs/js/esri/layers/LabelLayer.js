/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/layers/LabelLayer","dojo/_base/declare dojo/_base/lang dojo/_base/connect dojo/has dojox/gfx/_base esri/kernel esri/lang esri/SpatialReference esri/graphic esri/layers/GraphicsLayer esri/layers/LabelClass esri/renderers/SimpleRenderer esri/geometry/Geometry esri/geometry/Extent esri/geometry/Point esri/geometry/Polyline esri/geometry/Polygon esri/symbols/TextSymbol esri/symbols/ShieldLabelSymbol esri/symbols/SimpleLineSymbol".split(" "),function(z,F,K,L,G,M,N,S,O,P,H,I,T,J,Q,U,R,w,A,
V){z=z(P,{declaredClass:"esri.layers.LabelLayer",constructor:function(){this._featureLayers=[];this._zone=[];this._mainStore=[];this._PI=Math.PI;this._PI2=Math.PI/2;this._extent=null;this._y1=this._x1=this._y0=this._x0=this._ymax=this._ymin=this._xmax=this._xmin=0;this._scale=1},addFeatureLayer:function(a,b,c,g){this._featureLayers.push({featureLayer:a,labelClass:b,expression:c,options:g});K.connect(a,"onUpdateEnd",this,"_refresh")},getFeatureLayer:function(a){return this._featureLayers[a]},_refresh:function(){this._zone=
[];this._mainStore=[];this._extent=this._map.extent;this._xmin=this._extent.xmin;this._xmax=this._extent.xmax;this._ymin=this._extent.ymin;this._ymax=this._extent.ymax;this._scale=(this._xmax-this._xmin)/this._map.width;var a,b,c;for(a=0;a<this._featureLayers.length;a++){var g=this._featureLayers[a].featureLayer;if(g.visibleAtMapScale&&!g._suspended){var d=this._featureLayers[a].labelClass,h=this._featureLayers[a].expression,e=this._featureLayers[a].options,f=null,k=c=null,q=g.labelingInfo;if(q)for(b=
0;b<q.length;b++){var l=q[b];if(l){f=new I(l.symbol);c=this._convertLabelExpression(l.labelExpression);k=this._convertOptions(l);break}}d instanceof H&&(f=new I(d.symbol),c=this._convertLabelExpression(d.labelExpression),k=this._convertOptions(d));d&&!(d instanceof H)&&(f=d);h&&(c=h);e&&(k=e);this._featureLayers[a].labelRenderer=f;this._featureLayers[a].expression=c;this._featureLayers[a].options=k;b=g.renderer;d=c;h=g.graphics;for(c=0;c<h.length;c++)if(e=h[c],k=g._map._convertGeometry(this._extent,
e.geometry),this._extent.intersects(k)&&(q=N.substitute(e.attributes,d),null!==q&&""!==F.trim(q)&&f)){var n=f.getSymbol(e),n=n instanceof w?new w(n.toJson()):n instanceof A?new A(n.toJson()):new w;n.setText(q);var l=n.angle,m=0,p=0;if(b){var r=b.getSize(e),s=b.getSymbol(e);if(0!==r)p=m=r;else if(s)if("simplemarkersymbol"==s.type)p=m=s.size;else if("picturemarkersymbol"==s.type)m=s.width,p=s.height;else if("simplelinesymbol"==s.type||"cartographiclinesymbol"==s.type)m=s.width}r=n.getWidth()/2;n=n.getHeight()/
2;m=G.normalizedLength(m)/2;p=G.normalizedLength(p)/2;this._mainStore.push({fNumber:a,labelWidth:r,labelHeight:n,symbolWidth:m,symbolHeight:p,graphic:e,geometry:k,text:q,angle:l})}}}this._process();this.clear();for(b=0;b<this._zone.length;b++)d=this._zone[b],a=this._featureLayers[d.fNumber].labelRenderer.getSymbol(d.graphic),a=a instanceof w?new w(a.toJson()):a instanceof A?new A(a.toJson()):new w,"polyline"==d.graphic.geometry.type&&a.setAngle(d.angle*(180/this._PI)),a.setText(d.text),g=d.x,f=d.y,
a instanceof w&&(c=a.getHeight(),d=Math.sin(d.angle),g-=0.25*c*this._scale*d,f-=0.33*c*this._scale),g=new O(new Q(g,f,this._extent.spatialReference)),g.setSymbol(a),this.add(g)},_convertLabelExpression:function(a){return"$"+a.replace(RegExp("\\[","g"),"{").replace(RegExp("\\]","g"),"}")},_convertOptions:function(a){a=a.labelPlacement;var b=!0;"always-horizontal"==a&&(b=!1);return{pointPriorities:"above-center"==a?"AboveCenter":"above-left"==a?"AboveLeft":"above-right"==a?"AboveRight":"below-center"==
a?"BelowCenter":"below-left"==a?"BelowLeft":"below-right"==a?"BelowRight":"center-center"==a?"CenterCenter":"center-left"==a?"CenterLeft":"center-right"==a?"CenterRight":"AboveRight",lineLabelPlacement:"above-start"==a||"below-start"==a||"center-start"==a?"PlaceAtStart":"above-end"==a||"below-end"==a||"center-end"==a?"PlaceAtEnd":"PlaceAtCenter",lineLabelPosition:"above-after"==a||"above-along"==a||"above-before"==a||"above-start"==a||"above-end"==a?"Above":"below-after"==a||"below-along"==a||"below-before"==
a||"below-start"==a||"below-end"==a?"Below":"center-after"==a||"center-along"==a||"center-before"==a||"center-start"==a||"center-end"==a?"OnLine":"Above",labelRotation:b,howManyLabels:"OneLabel"}},_process:function(){var a;for(a=this._mainStore.length-1;0<=a;a--){var b=this._mainStore[a],c=Math.min(b.labelWidth,b.labelHeight),g=b.labelWidth+0*c,c=b.labelHeight+0*c,d=this._featureLayers[b.fNumber].options,h=d&&void 0!==d.lineLabelPlacement?d.lineLabelPlacement:"PlaceAtCenter",e=d&&void 0!==d.lineLabelPosition?
d.lineLabelPosition:"Above",f=d&&void 0!==d.pointPriorities?d.pointPriorities:"AboveRight",k=[2,2,1,3,0,2,3,3,2];"AboveLeft"==f?k=[1,2,2,2,0,3,2,3,3]:"AboveCenter"==f?k=[2,1,2,2,0,2,3,3,3]:"AboveRight"==f?k=[2,2,1,3,0,2,3,3,2]:"CenterLeft"==f?k=[2,2,3,1,0,3,2,2,3]:"CenterCenter"==f?k=[0,0,0,0,1,0,0,0,0]:"CenterRight"==f?k=[3,2,2,3,0,1,3,2,2]:"BelowLeft"==f?k=[2,3,3,2,0,3,1,2,2]:"BelowCenter"==f?k=[3,3,3,2,0,2,2,1,2]:"BelowRight"==f&&(k=[3,3,2,3,0,2,2,2,1]);f=d&&void 0!==d.labelRotation?d.labelRotation:
!0;d=b.angle*(this._PI/180);if("point"==b.geometry.type)this._generatePointPositions(b.fNumber,b.graphic,b.geometry,b.text,d,g,c,b.symbolWidth,b.symbolHeight,k);else if("multipoint"==b.geometry.type){h=b.geometry;for(e=0;e<h.points.length;e++)this._generatePointPositions(b.fNumber,b.graphic,h.points[e],b.text,d,g,c,b.symbolWidth,b.symbolHeight,k)}else"polyline"==b.geometry.type?this._generateLinePositions(b.fNumber,b.graphic,b.geometry,b.text,g,c,2*b.symbolHeight+c,h,e,f):"polygon"==b.geometry.type&&
this._generatePolygonPositions(b.fNumber,b.graphic,b.geometry,b.text,d,g,c)}},_generatePointPositions:function(a,b,c,g,d,h,e,f,k,q){var l=c.x;c=c.y;f=(f+h)*this._scale;k=(k+e)*this._scale;var n,m;for(n=1;3>=n;n++)for(m=1;9>=m;m++)if(q[m-1]==n)switch(m){case 1:if(this._findPlace(a,b,g,l-f,c+k,d,h,e))return;break;case 2:if(this._findPlace(a,b,g,l,c+k,d,h,e))return;break;case 3:if(this._findPlace(a,b,g,l+f,c+k,d,h,e))return;break;case 4:if(this._findPlace(a,b,g,l-f,c,d,h,e))return;break;case 5:if(this._findPlace(a,
b,g,l,c,d,h,e))return;break;case 6:if(this._findPlace(a,b,g,l+f,c,d,h,e))return;break;case 7:if(this._findPlace(a,b,g,l-f,c-k,d,h,e))return;break;case 8:if(this._findPlace(a,b,g,l,c-k,d,h,e))return;break;case 9:if(this._findPlace(a,b,g,l+f,c-k,d,h,e))return}},_generateLinePositions:function(a,b,c,g,d,h,e,f,k,q){var l=d*this._scale*d*this._scale,n,m,p;for(n=0;n<c.paths.length;n++){var r=c.paths[n],s=r.length,t=Math.floor((s-1)/2),u=0!==(s-1)%2?1:-1;"PlaceAtStart"==f&&(t=0,u=1);"PlaceAtEnd"==f&&(t=
s-2,u=-1);for(;0<=t&&t<s-1;){for(m=t;m<s;m++){var v=r[t][0],B=r[t][1],x=r[m][0]-v,w=r[m][1]-B;if(x*x+w*w>l){for(var y=Math.atan2(w,x);y>this._PI2;)y-=this._PI;for(;y<-this._PI2;)y+=this._PI;var z=Math.sin(y),A=Math.cos(y),C=0,D=0;"Above"==k&&(C=e*z*this._scale,D=e*A*this._scale);"Below"==k&&(C=-e*z*this._scale,D=-e*A*this._scale);if(1==m-t){if(this._clipLine(v,B,r[m][0],r[m][1])&&(v=this._x1-this._x0,p=this._y1-this._y0,v*v+p*p>l&&(m=Math.atan2(p,v),x=d/2+2*h,B=x*this._scale*Math.cos(m),x=x*this._scale*
Math.sin(m),"PlaceAtStart"==f?(v=this._x0+B,p=this._y0+x):"PlaceAtEnd"==f?(v=this._x1-B,p=this._y1-x):(v=this._x0+v/2,p=this._y0+p/2),this._findPlace(a,b,g,v-C,p+D,q?-m:0,d,h))))return}else{var E=0;for(p=t;p<=m;p++)E=Math.max(E,Math.abs((r[p][1]-B)*A-(r[p][0]-v)*z));if(E<h&&this._findPlace(a,b,g,v+x/2-C,B+w/2+D,q?-y:0,d,h))return}break}}t+=u}}},_generatePolygonPositions:function(a,b,c,g,d,h,e){var f,k;f=this._featureLayers[a].options;if("ManyLabels"==(f?f.howManyLabels:"OneLabel"))for(f=0;f<c.rings.length;f++)k=
this._findCentroid(c.rings[f],this._xmin,this._ymin,this._xmax,this._ymax),this._findPlace(a,b,g,k[0],k[1],d,h,e);else{k=this._findCentroidForFeature(c,this._xmin,this._ymin,this._xmax,this._ymax);var q=k[1],l=0;for(f=0;10>f;f++){l+=e/4;k=this._findCentroidForFeature(c,this._xmin,q+(l-e/4),this._xmax,q+(l+e/4));if(this._findPlace(a,b,g,k[0],k[1],d,h,e))break;k=this._findCentroidForFeature(c,this._xmin,q-(l+e/4),this._xmax,q-(l-e/4));if(this._findPlace(a,b,g,k[0],k[1],d,h,e))break}}},_findCentroid:function(a,
b,c,g,d){var h=a.length,e=[0,0],f=0,k=a[0][0],q=a[0][1];k>g&&(k=g);k<b&&(k=b);q>d&&(q=d);q<c&&(q=c);for(var l=1;l<h-1;l++){var n=a[l][0],m=a[l][1],p=a[l+1][0],r=a[l+1][1];n>g&&(n=g);n<b&&(n=b);m>d&&(m=d);m<c&&(m=c);p>g&&(p=g);p<b&&(p=b);r>d&&(r=d);r<c&&(r=c);var s=(n-k)*(r-q)-(p-k)*(m-q);e[0]+=s*(k+n+p);e[1]+=s*(q+m+r);f+=s}e[0]/=3*f;e[1]/=3*f;if(isNaN(e[0])||isNaN(e[1]))return e;c=[];this._fillBuffer(a,c,e);e[0]=this._sortBuffer(c,e[0],b,g);return e},_findCentroidForFeature:function(a,b,c,g,d){for(var h,
e=0,f=[0,0],k=0;k<a.rings.length;k++){var q=a.rings[k],l=q.length,n=q[0][0],m=q[0][1];n>g&&(n=g);n<b&&(n=b);m>d&&(m=d);m<c&&(m=c);for(h=1;h<l-1;h++){var p=q[h][0],r=q[h][1],s=q[h+1][0],t=q[h+1][1];p>g&&(p=g);p<b&&(p=b);r>d&&(r=d);r<c&&(r=c);s>g&&(s=g);s<b&&(s=b);t>d&&(t=d);t<c&&(t=c);var u=(p-n)*(t-m)-(s-n)*(r-m);f[0]+=u*(n+p+s);f[1]+=u*(m+r+t);e+=u}}f[0]/=3*e;f[1]/=3*e;if(isNaN(f[0])||isNaN(f[1]))return f;c=[];for(h=0;h<a.rings.length;h++)this._fillBuffer(a.rings[h],c,f);f[0]=this._sortBuffer(c,
f[0],b,g);return f},_fillBuffer:function(a,b,c){for(var g=a.length-1,d=a[0][1]>=a[g][1]?1:-1,h=0;h<=g;h++){var e=h,f=h+1;h==g&&(f=0);var k=a[e][0],e=a[e][1],q=a[f][0],f=a[f][1],l=f>=e?1:-1;if(e<=c[1]&&c[1]<=f||f<=c[1]&&c[1]<=e)c[1]!=e&&c[1]!=f?(b.push((c[1]-e)*(q-k)/(f-e)+k),d=l):c[1]==e&&c[1]!=f?(d!=l&&b.push(k),d=l):c[1]!=e&&c[1]==f?(b.push(q),d=l):c[1]==e&&c[1]==f&&(1==d&&b.push(k),b.push(q),d=l)}},_sortBuffer:function(a,b,c,g){var d=a.length;a.sort();if(0<d){for(var h=0,e=b=0;e<d-1;e+=2){var f=
Math.abs(a[e+1]-a[e]);!(a[e]<=c&&a[e+1]<=c)&&(!(a[e]>=g&&a[e+1]>=g)&&f>h)&&(h=f,b=e)}d=a[b];a=a[b+1];d>g&&(d=g);d<c&&(d=c);a>g&&(a=g);a<c&&(a=c);b=(d+a)/2}return b},_findPlace:function(a,b,c,g,d,h,e,f){if(isNaN(g)||isNaN(d)||g<this._xmin||g>this._xmax||d<this._ymin||d>this._ymax)return!1;var k=this._featureLayers[a].options;if(!(k&&void 0!==k.allowCrossScreen?k.allowCrossScreen:1))if(g-e*this._scale<this._xmin||g+e*this._scale>this._xmax||d-f*this._scale<this._ymin||d+f*this._scale>this._ymax)return!1;
for(var k=new J(-e*this._scale,-f*this._scale,e*this._scale,f*this._scale,null),q=0;q<this._zone.length;q++){var l=this._zone[q],n=l.angle,m=l.width*this._scale,p=l.height*this._scale,r=l.x-g,s=l.y-d;if(0===h&&0===n){if(l=new J(r-m,s-p,r+m,s+p,null),k.intersects(l))return!1}else{var t=0,u=1;0!==h&&(t=Math.sin(h),u=Math.cos(h));var l=r*u-s*t,r=r*t+s*u,n=n-h,t=Math.sin(n),u=Math.cos(n),v=-m*u- -p*t,s=-m*t+-p*u,n=+m*u- -p*t,w=+m*t+-p*u,m=l+v,p=r-s,t=l+n,u=r-w,v=l-v,s=r+s,l=l-n,r=r+w,n=new R;n.addRing([[m,
p],[t,u],[v,s],[l,r],[m,p]]);if(k.intersects(n))return!1}}for(;h>this._PI2;)h-=this._PI;for(;h<-this._PI2;)h+=this._PI;this._zone.push({fNumber:a,graphic:b,text:c,angle:h,x:g,y:d,width:e,height:f});return!0},_clipLine:function(a,b,c,g){for(var d=this._code(a,b),h=this._code(c,g);0!==d||0!==h;){if(0!==(d&h))return!1;var e=c-a,f=g-b;0!==d?(a<this._xmin?(b+=f*(this._xmin-a)/e,a=this._xmin):a>this._xmax?(b+=f*(this._xmax-a)/e,a=this._xmax):b<this._ymin?(a+=e*(this._ymin-b)/f,b=this._ymin):b>this._ymax&&
(a+=e*(this._ymax-b)/f,b=this._ymax),d=this._code(a,b)):(c<this._xmin?(g+=f*(this._xmin-c)/e,c=this._xmin):c>this._xmax?(g+=f*(this._xmax-c)/e,c=this._xmax):g<this._ymin?(c+=e*(this._ymin-g)/f,g=this._ymin):g>this._ymax&&(c+=e*(this._ymax-g)/f,g=this._ymax),h=this._code(c,g))}this._x0=a;this._y0=b;this._x1=c;this._y1=g;return!0},_code:function(a,b){return(a<this._xmin?1:0)<<3|(a>this._xmax?1:0)<<2|(b<this._ymin?1:0)<<1|(b>this._ymax?1:0)}});L("extend-esri")&&F.setObject("layers.LabelLayer",z,M);return z});