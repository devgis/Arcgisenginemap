/*
 COPYRIGHT 2009 ESRI

 TRADE SECRETS: ESRI PROPRIETARY AND CONFIDENTIAL
 Unpublished material - all rights reserved under the
 Copyright Laws of the United States and applicable international
 laws, treaties, and conventions.

 For additional information, contact:
 Environmental Systems Research Institute, Inc.
 Attn: Contracts and Legal Services Department
 380 New York Street
 Redlands, California, 92373
 USA

 email: contracts@esri.com
 */
//>>built
define("esri/layers/ArcGISImageServiceLayer","dojo/_base/declare dojo/_base/lang dojo/_base/Deferred dojo/_base/array dojo/_base/json dojo/_base/config dojo/has dojo/io-query esri/kernel esri/config esri/lang esri/request esri/deferredUtils esri/urlUtils esri/geometry/Extent esri/geometry/Point esri/SpatialReference esri/layers/MosaicRule esri/layers/DynamicMapServiceLayer esri/layers/TimeInfo esri/layers/Field esri/graphic esri/tasks/ImageServiceIdentifyTask esri/tasks/ImageServiceIdentifyParameters esri/geometry/Polygon".split(" "),
function(r,f,v,x,t,C,F,G,H,D,z,u,h,B,E,I,Q,A,J,K,L,M,N,O,P){r=r(J,{declaredClass:"esri.layers.ArcGISImageServiceLayer",_eventMap:{"rendering-change":!0,"mosaic-rule-change":!0},constructor:function(a,c){this._url=B.urlToObject(a);var b=c&&c.imageServiceParameters;this.format=b&&b.format;this.interpolation=b?b.interpolation:null;this.compressionQuality=b?b.compressionQuality:null;this.bandIds=b?b.bandIds:null;this.mosaicRule=b?b.mosaicRule:null;this.renderingRule=b?b.renderingRule:null;this._params=
f.mixin({},this._url.query,{f:"image",interpolation:this.interpolation,format:this.format,compressionQuality:this.compressionQuality,bandIds:this.bandIds?this.bandIds.join(","):null},b?b.toJson():{});this._initLayer=f.hitch(this,this._initLayer);this._queryVisibleRastersHandler=f.hitch(this,this._queryVisibleRastersHandler);this._visibleRasters=[];this.useMapImage=c&&c.useMapImage||!1;this.infoTemplate=c&&c.infoTemplate;this._rasterAttributeTableFields=[];this._rasterAttributeTableFeatures=[];this._loadCallback=
c&&c.loadCallback;(b=c&&c.resourceInfo)?this._initLayer(b):u({url:this._url.path,content:f.mixin({f:"json"},this._url.query),callbackParamName:"callback",load:this._initLayer,error:this._errorHandler});this.registerConnectEvents()},disableClientCaching:!1,_initLayer:function(a,c){this._findCredential();(this.credential&&this.credential.ssl||a&&a._ssl)&&this._useSSL();var b=this.minScale,e=this.maxScale;f.mixin(this,a);this.minScale=b;this.maxScale=e;this.initialExtent=this.fullExtent=this.extent=
new E(a.extent);this.spatialReference=this.initialExtent.spatialReference;this.pixelSizeX=parseFloat(this.pixelSizeX);this.pixelSizeY=parseFloat(this.pixelSizeY);for(var g=this.minValues,k=this.maxValues,d=this.meanValues,p=this.stdvValues,q=this.bands=[],b=0,e=this.bandCount;b<e;b++)q[b]={min:g[b],max:k[b],mean:d[b],stddev:p[b]};this.timeInfo=(b=this.timeInfo)&&b.timeExtent?new K(b):null;e=this.fields=[];if(g=a.fields)for(b=0;b<g.length;b++)e.push(new L(g[b]));this.version=a.currentVersion;this.version||
(this.version="fields"in a||"objectIdField"in a||"timeInfo"in a?10:9.3);z.isDefined(a.minScale)&&!this._hasMin&&this.setMinScale(a.minScale);z.isDefined(a.maxScale)&&!this._hasMax&&this.setMaxScale(a.maxScale);b={};a.defaultMosaicMethod?(b.method=a.defaultMosaicMethod,b.operation=a.mosaicOperator,b.sortField=a.sortField,b.sortValue=a.sortValue):b.method=A.METHOD_NONE;this.defaultMosaicRule=new A(b);this.defaultMosaicRule.ascending=!0;10<this.version&&this.hasRasterAttributeTable&&this.getRasterAttributeTable().then(f.hitch(this,
function(a){a&&(a.features&&0<a.features.length)&&(this._rasterAttributeTableFeatures=f.clone(a.features));a&&(a.fields&&0<a.fields.length)&&(this._rasterAttributeTableFields=f.clone(a.fields))}));this.loaded=!0;this.onLoad(this);if(b=this._loadCallback)delete this._loadCallback,b(this)},getKeyProperties:function(){var a=this._url.path+"/keyProperties",c=new v(h._dfdCanceller);10<this.version?(c._pendingDfd=u({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),c._pendingDfd.then(function(a){c.callback(a)},
function(a){c.errback(a)})):(a=Error("Layer does not have key properties"),a.log=C.isDebug,c.errback(a));return c},getRasterAttributeTable:function(){var a=this._url.path+"/rasterAttributeTable",c=new v(h._dfdCanceller);10<this.version&&this.hasRasterAttributeTable?(c._pendingDfd=u({url:a,content:{f:"json"},handleAs:"json",callbackParamName:"callback"}),c._pendingDfd.then(function(a){c.callback(a)},function(a){c.errback(a)})):(a=Error("Layer does not support raster attribute table"),a.log=C.isDebug,
c.errback(a));return c},_getRasterAttributeTableFeatures:function(){var a=new v;if(this._rasterAttributeTableFeatures&&0<this._rasterAttributeTableFeatures.length)return a.resolve(this._rasterAttributeTableFeatures),a;if(10<this.version&&this.hasRasterAttributeTable)return a=this.getRasterAttributeTable(),a.then(f.hitch(this,function(a){a&&(a.features&&0<a.features.length)&&(this._rasterAttributeTableFeatures=f.clone(a.features))})),a;a.resolve(this._rasterAttributeTableFeatures);return a},getCustomRasterFields:function(a){var c=
a?a.rasterAttributeTableFieldPrefix:"",b={name:"Raster.ItemPixelValue",alias:"Item Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeString"};a=this.fields?f.clone(this.fields):[];var e=a.length;a[e]={name:"Raster.ServicePixelValue",alias:"Service Pixel Value",domain:null,editable:!1,length:50,type:"esriFieldTypeString"};if(this.capabilities&&-1<this.capabilities.toLowerCase().indexOf("catalog")||this.fields&&0<this.fields.length)a[e+1]=b;this._rasterAttributeTableFields&&0<this._rasterAttributeTableFields.length&&
(b=x.filter(this._rasterAttributeTableFields,function(a){return"esriFieldTypeOID"!==a.type&&"value"!==a.name.toLowerCase()}),b=x.map(b,function(a){var b=f.clone(a);b.name=c+a.name;return b}),a=a.concat(b));return a},getImageUrl:function(a,c,b,e){var g=a.spatialReference.wkid||t.toJson(a.spatialReference.toJson());delete this._params._ts;var k=this._url.path+"/exportImage?";f.mixin(this._params,{bbox:a.xmin+","+a.ymin+","+a.xmax+","+a.ymax,imageSR:g,bboxSR:g,size:c+","+b},this.disableClientCaching?
{_ts:(new Date).getTime()}:{});var d=this._params.token=this._getToken();a=B.addProxy(k+G.objectToQuery(f.mixin(this._params,{f:"image"})));a.length>D.defaults.io.postLength||this.useMapImage?this._jsonRequest=u({url:k,content:f.mixin(this._params,{f:"json"}),callbackParamName:"callback",load:function(a,b){var c=a.href;d&&(c+=-1===c.indexOf("?")?"?token\x3d"+d:"\x26token\x3d"+d);e(B.addProxy(c))},error:this._errorHandler}):e(a)},onRenderingChange:function(){},onMosaicRuleChange:function(){},setInterpolation:function(a,
c){this.interpolation=this._params.interpolation=a;c||this.refresh(!0)},setCompressionQuality:function(a,c){this.compressionQuality=this._params.compressionQuality=a;c||this.refresh(!0)},setBandIds:function(a,c){var b=!1;this.bandIds!==a&&(b=!0);this.bandIds=a;this._params.bandIds=a.join(",");if(b&&!c)this.onRenderingChange();c||this.refresh(!0)},setDefaultBandIds:function(a){this.bandIds=this._params.bandIds=null;a||this.refresh(!0)},setDisableClientCaching:function(a){this.disableClientCaching=
a},setMosaicRule:function(a,c){var b=!1;this.mosaicRule!==a&&(b=!0);this.mosaicRule=a;this._params.mosaicRule=t.toJson(a.toJson());if(b&&!c)this.onMosaicRuleChange();c||this.refresh(!0)},setRenderingRule:function(a,c){var b=!1;this.renderingRule!==a&&(b=!0);this.renderingRule=a;this._params.renderingRule=a?t.toJson(a.toJson()):null;if(b&&!c)this.onRenderingChange();c||this.refresh(!0)},setImageFormat:function(a,c){this.format=this._params.format=a;c||this.refresh(!0)},setInfoTemplate:function(a){this.infoTemplate=
a},setDefinitionExpression:function(a,c){var b=this.mosaicRule?this.mosaicRule.toJson():{};this.mosaicRule||(this.defaultMosaicRule?b=this.defaultMosaicRule.toJson():b.method=A.METHOD_NONE);b.where=a;b=new A(b);this.setMosaicRule(b,c);return this},getDefinitionExpression:function(){return this.mosaicRule?this.mosaicRule.where:null},refresh:function(a){if(a)this.inherited(arguments);else{var c=this.disableClientCaching;this.disableClientCaching=!0;this.inherited(arguments);this.disableClientCaching=
c}},exportMapImage:function(a,c){var b=D.defaults.map,b=f.mixin({size:b.width+","+b.height},this._params,a?a.toJson(this.normalization):{},{f:"json"});delete b._ts;this._exportMapImage(this._url.path+"/exportImage",b,c)},queryVisibleRasters:function(a,c,b,e){var g=this._map,f=h._fixDfd(new v(h._dfdCanceller));this._visibleRasters=[];var d,p,q=!0;if(this.infoTemplate&&this.infoTemplate.info.fieldInfos&&0<this.infoTemplate.info.fieldInfos.length){q=!1;for(d=0;d<this.infoTemplate.info.fieldInfos.length;d++)(p=
this.infoTemplate.info.fieldInfos[d])&&(p.visible&&"raster.servicepixelvalue"!==p.fieldName.toLowerCase())&&(q=!0)}d=new O;d.geometry=a.geometry.getCenter();d.returnGeometry=this._map.spatialReference.equals(this.spatialReference);d.returnCatalogItems=q;d.timeExtent=a.timeExtent;d.mosaicRule=this.mosaicRule?this.mosaicRule:null;d.renderingRule=this.renderingRule?this.renderingRule:null;g&&(a=new I((g.extent.xmax-g.extent.xmin)/(2*g.width),(g.extent.ymax-g.extent.ymin)/(2*g.height),g.extent.spatialReference),
d.pixelSize=a);var l=this;a=new N(this.url);(f._pendingDfd=a.execute(d)).addCallbacks(function(a){l._queryVisibleRastersHandler(a,c,b,e,f)},function(a){l._resolve([a],null,e,f,!0)});return f},_queryVisibleRastersHandler:function(a,c,b,e,g){function k(){var a=this.getCustomRasterFields(c),e=this._getDomainFields(a),l=c?c.returnDomainValues:!1,h=c&&c.rasterAttributeTableFieldPrefix,k,m,u,s,w,r,v,t;this._getRasterAttributeTableFeatures().then(f.hitch(this,function(a){for(k=0;k<d.length;k++){n=d[k];n.setInfoTemplate(this.infoTemplate);
if(p&&(m=p,q&&q.length>=k&&(u=q[k],m=u.replace(/ /gi,", ")),n.attributes["Raster.ItemPixelValue"]=m,n.attributes["Raster.ServicePixelValue"]=p,a&&0<a.length&&(s=x.filter(a,function(a){if(a&&a.attributes)return a.attributes.hasOwnProperty("Value")?a.attributes.Value==m:a.attributes.VALUE==m}),0<s.length&&(w=f.clone(s[0]),h&&w)))){t={};for(r in w.attributes)w.attributes.hasOwnProperty(r)&&(v=h+r,t[v]=w.attributes[r]);w.attributes=t;n.attributes=f.mixin(n.attributes,w.attributes)}l&&(e&&0<e.length)&&
x.forEach(e,function(a){if(a){var b=n.attributes[a.name];z.isDefined(b)&&(b=this._getDomainValue(a.domain,b),z.isDefined(b)&&(n.attributes[a.name]=b))}},this);y.push(n);this._visibleRasters.push(n)}this._resolve([y,null,!0],null,b,g)}))}var d=a.features,p=a.value,q;e=[];var l=0,m=0,h=this;a.catalogItems&&(d=a.catalogItems.features,q=a.properties.Values);this._visibleRasters=[];var n,s=this.objectIdField;a=-1<p.toLowerCase().indexOf("nodata");p&&(!d&&!a)&&(s="ObjectId",d=[],n=new M(new E(this.fullExtent),
null,{ObjectId:0}),d.push(n));a=this.capabilities&&-1<this.capabilities.toLowerCase().indexOf("catalog")||this.fields&&0<this.fields.length;var y=[];if(d){if(a)for(l=0;l<d.length;l++)e.push(d[l].attributes[s]);!this._map.spatialReference.equals(this.spatialReference)&&0<e.length?u({url:this._url.path+"/query",content:{f:"json",objectIds:e.join(","),returnGeometry:!0,outSR:t.toJson(h._map.spatialReference.toJson()),outFields:s},handleAs:"json",callbackParamName:"callback",load:function(a){if(0===a.features.length)h._resolve([y,
null,null],null,b,g);else{for(l=0;l<a.features.length;l++)for(m=0;m<d.length;m++)d[m].attributes[s]==a.features[l].attributes[s]&&(d[m].geometry=new P(a.features[l].geometry),d[m].geometry.setSpatialReference(h._map.spatialReference));k.call(h)}},error:function(a){h._resolve([y,null,null],null,b,g)}}):k.call(this)}else this._resolve([y,null,null],null,b,g)},getVisibleRasters:function(){var a=this._visibleRasters,c=[],b;for(b in a)a.hasOwnProperty(b)&&c.push(a[b]);return c},_getDomainFields:function(a){if(a){var c=
[];x.forEach(a,function(a){if(a.domain){var e={};e.name=a.name;e.domain=a.domain;c.push(e)}});return c}},_getDomainValue:function(a,c){if(a&&a.codedValues){var b;x.some(a.codedValues,function(a){return a.code===c?(b=a.name,!0):!1});return b}},_resolve:function(a,c,b,e,f){c&&this[c].apply(this,a);b&&b.apply(null,a);e&&h._resDfd(e,a,f)}});F("extend-esri")&&f.setObject("layers.ArcGISImageServiceLayer",r,H);return r});